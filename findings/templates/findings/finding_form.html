{% extends "base_adminlte.html" %}
{% block title %}Add Finding{% endblock %}
{% block content %}
<div class="card card-primary card-outline">
  <div class="card-header">
    <h3 class="card-title">Add Finding to Project: {{ project.project_name }}</h3>
  </div>
  <div class="card-body">
    <form method="post" id="finding-form">
      {% csrf_token %}
      {% for field in form %}
      <div class="form-group {% if field.name == 'save_to_vkb' %}form-check{% endif %}">
        {% if field.name == 'save_to_vkb' %}
        {{ field }} <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% else %}
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% endif %}

        {% if field.help_text %}
        <small class="form-text text-muted">{{ field.help_text }}</small>
        {% endif %}
        {% for error in field.errors %}
        <div class="text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      {% endfor %}
      <button type="submit" class="btn btn-primary">Save</button>
      <a href="{% url 'project_detail' project.pk %}" class="btn btn-secondary ml-2">Cancel</a>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(function () {
    // Initialize Select2
    $('select').select2({
      theme: 'bootstrap4'
    })

    // Add form-control class to inputs
    $('input:not([type="checkbox"]):not([type="radio"]), select, textarea').addClass('form-control');
    $('input[type="checkbox"]').addClass('form-check-input');

    // Custom VKB fetch logic
    // Note: using $('#id_vkb') for jQuery consistent with above
    $('#id_vkb').on('change', function () {
      const vkbId = $(this).val();
      if (!vkbId) return;

      $.ajax({
        url: `/vkb/api/${vkbId}/`,
        success: function (data) {
          $('#id_title').val(data.title);
          $('#id_description').val(data.description);
          $('#id_impact').val(data.impact);
          $('#id_recommendation').val(data.recommendation);

          // For Select2, valid way to set value is .val().trigger('change')
          if ($('#id_vkb_category').length) {
            $('#id_vkb_category').val(data.category).trigger('change');
          }
        }
      });
    });
  });
</script>
{% endblock %}