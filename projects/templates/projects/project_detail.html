<h1>Project Detail</h1>

<h2>{{ project.project_name }}</h2>
<p><strong>Status:</strong> {{ project.status }}</p>
<p><strong>Start Date:</strong> {{ project.start_date }}</p>
<p><strong>End Date:</strong> {{ project.end_date|default:"-" }}</p>
<p><strong>Description:</strong> {{ project.description|linebreaks }}</p>
<h3>📈 SPI (Scheduled Performance Index)</h3>
{% if project.status == 'Completed' %}
  {% if project.spi >= 1 %}
    <p><strong>SPI:</strong> {{ project.spi }} 🟢 – On time or faster</p>
  {% else %}
    <p><strong>SPI:</strong> {{ project.spi }} 🔴 – Delayed</p>
  {% endif %}
{% else %}
  {% if project.spi >= 1 %}
    <p><strong>SPI (est.):</strong> {{ project.spi }} 🟢 – Estimated, project not yet completed</p>
  {% else %}
    <p><strong>SPI (est.):</strong> {{ project.spi }} 🔴 – Estimated, project not yet completed</p>
  {% endif %}
{% endif %}
<hr>

<h3>🧑‍💻 Assignments (Project Team)</h3>
<a href="{% url 'add_assignment' project.pk %}">+ Assign New User</a>
<ul>
    {% for a in project.assignment_set.all %}
        <li>{{ a.user.full_name }} — {{ a.title }}
            <a href="{% url 'remove_assignment' a.pk %}">Remove</a>
        </li>
    {% empty %}
        <li>No team members assigned.</li>
    {% endfor %}
</ul>


<h3>📞 Stakeholders</h3>
<a href="{% url 'add_stakeholder' project.pk %}">+ Add Stakeholder</a>
<ul>
    {% for s in project.stakeholder_set.all %}
        <li>
            {{ s.name }} — {{ s.organization }}<br>
            {{ s.email }} {{ s.phone }}
            <a href="{% url 'remove_stakeholder' s.pk %}">Remove</a>
        </li>
    {% empty %}
        <li>No stakeholders added.</li>
    {% endfor %}
</ul>


<h3>🧪 Scanning Reports</h3>
<ul>
    {% for scan in scans %}
        <li>{{ scan.scan_tool }} — {{ scan.report_file.name }}</li>
    {% empty %}
        <li>No scans uploaded.</li>
    {% endfor %}
</ul>

<h3>🛠 Findings</h3>
<a href="{% url 'create_finding' project.pk %}">+ Add Finding</a>

<table border="1">
  <thead>
    <tr>
      <th>Title</th>
      <th>Severity</th>
      <th>Status</th>
      <th>Is Late?</th>
      <th>SLA Delay</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for f in project.finding_set.all %}
      <tr {% if f.is_late %} style="background-color: #ffe5e5;" {% endif %}>
        <td>{{ f.title }}</td>
        <td>{{ f.severity }}</td>
        <td>{{ f.status }}</td>
        <td>{% if f.is_late %} ✅ {% else %} ❌ {% endif %}</td>
        <td>{{ f.sla_delay_days }} days</td>
        <td>
          <a href="{% url 'finding_detail' f.id %}">View</a> |
          <a href="{% url 'finding_edit' f.id %}">Edit</a> |
          <a href="{% url 'finding_delete' f.id %}">Delete</a>
        </td>
        <td>
      </tr>
    {% empty %}
      <tr><td colspan="6">No findings yet.</td></tr>
    {% endfor %}
  </tbody>
</table>


<br>
<a href="{% url 'project_list' %}">⬅ Back to Project List</a>

<h4>📚 Report History</h4>
<a href="{% url 'generate_report' project.id 'pdf' %}">📄 Generate PDF</a> |
<a href="{% url 'generate_report' project.id 'docx' %}">📝 Generate Word</a>

<table>
  <tr>
    <th>File</th>
    <th>Status</th>
    <th>Format</th>
    <th>Created</th>
    <th>Actions</th>
  </tr>
  {% for r in project.reports.all %}
  <tr>
    <td>{{ r.file_name }}</td>
    <td>{{ r.status }}</td>
    <td>{{ r.format }}</td>
    <td>{{ r.created_at }}</td>
    <td>
      {% if r.status == 'done' %}
        <a href="{% url 'download_report' r.id %}">⬇️ Download</a>
      {% else %}
        ⏳
      {% endif %}
      | <a href="{% url 'delete_report' r.id %}">🗑️ Delete</a>
    </td>
  </tr>
  {% endfor %}
</table>
